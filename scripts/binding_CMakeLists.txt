cmake_minimum_required(VERSION 3.14)
project(rmc75e LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# Use modern FindPython (required for CMake >= 4.0 where FindPythonInterp was removed)
set(PYBIND11_FINDPYTHON ON)

# pybind11 (installed via pip)
find_package(pybind11 REQUIRED)

# Paths passed from build_binding.py
# EIP_INCLUDE_DIR, SRC_DIR, LIB_DIR

pybind11_add_module(rmc75e
    ${SRC_DIR}/bindings.cpp
    ${SRC_DIR}/RMC75EClient.cpp
)

target_include_directories(rmc75e PRIVATE
    ${EIP_INCLUDE_DIR}
    ${SRC_DIR}
)

# Version from pyproject.toml (passed via -DRMC75E_VERSION=x.y.z)
if(DEFINED RMC75E_VERSION)
    target_compile_definitions(rmc75e PRIVATE RMC75E_VERSION="${RMC75E_VERSION}")
endif()

# Link against pre-built libraries
if(WIN32)
    # Windows: link against .lib import libraries
    find_library(EIP_LIB NAMES EIPScanner PATHS ${LIB_DIR} NO_DEFAULT_PATH)

    if(NOT EIP_LIB)
        message(FATAL_ERROR "EIPScanner.lib not found in ${LIB_DIR}")
    endif()

    target_link_libraries(rmc75e PRIVATE ${EIP_LIB} ws2_32)
else()
    # Linux: link against .so with RPATH
    target_link_libraries(rmc75e PRIVATE
        -L${LIB_DIR}
        -lEIPScanner
        -lpthread
    )
    set_target_properties(rmc75e PROPERTIES
        BUILD_RPATH "${LIB_DIR}"
        INSTALL_RPATH "$ORIGIN/lib"
    )
endif()

# Output directly to SRC_DIR
set_target_properties(rmc75e PROPERTIES
    LIBRARY_OUTPUT_DIRECTORY ${SRC_DIR}
    RUNTIME_OUTPUT_DIRECTORY ${SRC_DIR}
)

# For multi-config generators (MSVC), flatten output directories
foreach(CONFIG_TYPE ${CMAKE_CONFIGURATION_TYPES})
    string(TOUPPER ${CONFIG_TYPE} CONFIG_TYPE_UPPER)
    set_target_properties(rmc75e PROPERTIES
        LIBRARY_OUTPUT_DIRECTORY_${CONFIG_TYPE_UPPER} ${SRC_DIR}
        RUNTIME_OUTPUT_DIRECTORY_${CONFIG_TYPE_UPPER} ${SRC_DIR}
    )
endforeach()
